<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="styles.css">
  <meta charset="utf-8">
  <title>Owner Dashboard</title>
</head>
<body>
  <h2>Welcome to your Dashboard</h2>
  <div id="profile"></div>
  <div id="shareLink"></div>
  <h3>Your Clients</h3>
  <ul id="clientList"></ul>
  <button id="logout">Logout</button>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      // Fetch owner profile
      const ownerDoc = await getDoc(doc(db, "owners", user.uid));
      if (!ownerDoc.exists()) {
        alert("Owner record not found!");
        return;
      }

      const ownerData = ownerDoc.data();

      // Profile section
      const createdDate = ownerData.createdAt ? ownerData.createdAt.toDate().toLocaleString() : "N/A";
      document.getElementById("profile").innerHTML = `
        <h3>My Profile</h3>
        <p><b>Name:</b> ${ownerData.name}</p>
        <p><b>Email:</b> ${ownerData.email}</p>
        <p><b>Signup Date:</b> ${createdDate}</p>
      `;

      // Generate unique client form link
      const repoName = window.location.pathname.split("/")[1];
      const baseUrl = window.location.origin;
      const formLink = `${baseUrl}/${repoName}/client-form.html?owner=${ownerData.customId}`;

      document.getElementById("shareLink").innerHTML = `
        <h3>Your Client Form Link:</h3>
        <a href="${formLink}" target="_blank">${formLink}</a>
        <button id="copyLink">Copy Link</button>
      `;

      document.getElementById("copyLink").addEventListener("click", () => {
        navigator.clipboard.writeText(formLink);
        alert("Link copied!");
      });

      // Fetch clients
      const clientList = document.getElementById("clientList");
      clientList.innerHTML = "";
      const querySnapshot = await getDocs(collection(db, "owners", user.uid, "clients"));
      querySnapshot.forEach(docSnap => {
        const c = docSnap.data();
        const li = document.createElement("li");
        li.textContent = `${c.name} â€” ${c.email}`;
        clientList.appendChild(li);
      });

      document.getElementById("logout").addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "index.html";
      });
    });
  </script>
</body>
</html>
